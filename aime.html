<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AIME Practice</title>
  <!-- MathJax configuration: TeX and MathML input, delay typesetting -->
  <script>
    window.MathJax = {
      loader: {load: ['input/tex', 'input/mml', 'output/chtml']},
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      options: {
        skipHtmlTags: ['script','noscript','style','textarea','pre','asy'],
        enableMenu: false
      },
      startup: { typeset: false }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- Asymptote.js for <asy> diagrams -->
  <script src="https://cdn.jsdelivr.net/npm/asymptote.js@0.3.0/dist/asy.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width:800px; margin:2em auto; text-align:center; }
    .problem-container { border:2px solid #000; padding:1em; margin-bottom:1em; text-align:left; }
    #answer-box { margin:1em 0; }
    #answer-box input { width:60px; padding:0.5em; text-align:center; }
    #answer-box button { padding:0.5em 1em; margin-left:0.5em; }
    #feedback { font-size:1.1em; margin-top:0.5em; }
  </style>
</head>
<body>
  <h1>AIME Practice</h1>
  <div id="problem-label">Loading…</div>
  <div id="problem-container" class="problem-container">Loading problem…</div>
  <div id="answer-box">
    <input id="answer" placeholder="Answer" />
    <button id="submit-btn" disabled>Submit</button>
    <button id="next-btn">Next</button>
  </div>
  <div id="feedback"></div>

  <script>
    const RAW_BASE = 'https://raw.githubusercontent.com/x-kevinl/ui/main/Problems';
    const config = {
      exams: Array.from({length:25}, (_,i) => `${2000+i}I`).concat(Array.from({length:25}, (_,i) => `${2000+i}II`)),
      maxProblems: { I:15, II:15 }
    };
    let current;

    function getRandomProblem() {
      const exam = config.exams[Math.floor(Math.random()*config.exams.length)];
      const type = exam.endsWith('II') ? 'II' : 'I';
      const year = exam.slice(0, exam.length - type.length);
      const num = Math.floor(Math.random()*config.maxProblems[type]) + 1;
      return { year, type, num };
    }

    async function loadProblem() {
      current = getRandomProblem();
      document.getElementById('problem-label').textContent = `AIME ${current.year}${current.type} #${current.num}`;
      const url = `${RAW_BASE}/${current.year}/${current.type}/${current.num}/Problem.txt`;
      try {
        let raw = await fetch(url).then(r => r.ok ? r.text() : Promise.reject(r.status));
        raw = raw.replace(/\[\[|\]\]/g, '').replace(/==[^=]+==/g, '');
        raw = raw.replace(/<cmath>([\s\S]*?)<\/cmath>/gi, (_m,p1) => `$$${p1}$$`);
        raw = raw.replace(/<math>([\s\S]*?)<\/math>/gi, (_m,p1) => `$${p1}$`);
        const container = document.getElementById('problem-container');
        container.innerHTML = raw;
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('feedback').textContent = '';
        await renderAsyDiagrams(container);
        await MathJax.typesetPromise([container]);
      } catch(err) {
        console.error('Fetch error', err);
        document.getElementById('problem-container').textContent = 'Failed to load problem.';
      }
    }

    async function renderAsyDiagrams(root) {
      for (const elem of root.querySelectorAll('asy')) {
        try {
          const svg = await Asy.render(elem.textContent);
          const div = document.createElement('div'); div.innerHTML = svg;
          elem.replaceWith(div);
        } catch (e) {
          console.error('Asy error', e);
        }
      }
    }

    async function handleSubmit() {
      const ansStr = document.getElementById('answer').value.trim();
      const feedbackEl = document.getElementById('feedback');
      const userNum = parseInt(ansStr, 10);
      if (isNaN(userNum)) {
        feedbackEl.textContent = 'Enter a numeric answer';
        feedbackEl.style.color = 'orange';
        return; // do not disable submit, allow retry
      }
      const ansUrl = `${RAW_BASE}/${current.year}/${current.type}/${current.num}/Answer.txt`;
      try {
        const rawAns = await fetch(ansUrl).then(r => r.ok ? r.text() : Promise.reject(r.status));
        const correctNum = parseInt(rawAns.trim(), 10);
        if (userNum === correctNum) {
          feedbackEl.textContent = '✅ Correct!';
          feedbackEl.style.color = 'green';
        } else {
          feedbackEl.textContent = `❌ Incorrect. Answer: ${correctNum}`;
          feedbackEl.style.color = 'red';
        }
      } catch (e) {
        console.error('Answer fetch error', e);
        feedbackEl.textContent = 'Could not load answer file.';
        feedbackEl.style.color = 'darkred';
      }
      document.getElementById('submit-btn').disabled = true;
    }

    document.getElementById('submit-btn').onclick = handleSubmit;
    document.getElementById('next-btn').onclick = () => {
      document.getElementById('answer').value = '';
      document.getElementById('submit-btn').disabled = true;
      document.getElementById('feedback').textContent = '';
      loadProblem();
    };

    window.addEventListener('DOMContentLoaded', loadProblem);
  </script>
</body>
</html>
