<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>F=ma Practice</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2em auto;
      padding: 0 1em;
    }
    #problem-container {
      text-align: center;
    }
    #exam-label {
      margin-bottom: 0.5em;
      color: gray;
      font-style: italic;
    }
    /* wrapper now centered at 90% width with a darker box */
    #image-wrapper {
      display: block;
      width: 90%;
      max-width: 800px;
      margin: 0 auto 1em;
      border: 2px solid #000;
      padding: 0.5em;
      box-sizing: border-box;
    }
    /* images fill the wrapper and stack */
    .problem-image {
      display: block;
      width: 100%;
      height: auto;
      margin-bottom: 1em;
      border: none;
    }
    #answer-box {
      margin-top: 1em;
    }
    #answer-box input {
      width: 60%;
      padding: 0.5em;
      font-size: 1em;
      text-transform: uppercase;
    }
    #answer-box button {
      padding: 0.5em 1em;
      font-size: 1em;
      margin-left: 0.5em;
    }
    #feedback {
      margin-top: 1em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="problem-container">
    <h1>F=ma Practice</h1>
    <div id="exam-label"></div>
    <div id="image-wrapper"></div>
    <div id="answer-box">
      <input type="text" id="answer" maxlength="1" />
      <button id="submit-btn">Submit</button>
    </div>
    <div id="feedback"></div>
  </div>

  <script>
    const config = {
      exams: ['2022A','2022B','2023','2024'],
      maxProblems: { '2022A':25, '2022B':25, '2023':25, '2024':25 }
    };

    let currentExam, currentNum, answerLines = [];

    async function fetchImageParts(exam, num) {
      const base = `/static/images/fma/${exam}/${num}`;
      const ext  = '.webp';
      const parts = [];
      for (let sfx of ['a','b']) {
        const url = base + sfx + ext;
        try {
          if ((await fetch(url, {method:'HEAD'})).ok) {
            parts.push(url);
          }
        } catch {}
      }
      if (!parts.length) {
        const url = base + ext;
        try {
          if ((await fetch(url, {method:'HEAD'})).ok) {
            parts.push(url);
          }
        } catch {}
      }
      return parts;
    }

    async function loadRandomProblem() {
      // pick a random exam and problem number
      currentExam = config.exams[
        Math.floor(Math.random() * config.exams.length)
      ];
      currentNum = Math.floor(
        Math.random() * config.maxProblems[currentExam]
      ) + 1;

      // update exam label
      document.getElementById('exam-label').textContent =
        `Exam ${currentExam}`;

      // clear previous images
      const wrapper = document.getElementById('image-wrapper');
      wrapper.innerHTML = '';

      // fetch and append all parts (a/b or base)
      const imgs = await fetchImageParts(currentExam, currentNum);
      imgs.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.alt = `F=ma ${currentExam} #${currentNum}`;
        img.className = 'problem-image';
        wrapper.appendChild(img);
      });

      // reset answer UI
      document.getElementById('answer').value = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('submit-btn').textContent = 'Submit';

      // load the answer key
      try {
        const keyUrl = `/static/images/fma/${currentExam}/key.txt`;
        const keyTxt = await (await fetch(keyUrl)).text();
        answerLines = keyTxt
          .split(/\r?\n/)
          .map(l => l.trim().toUpperCase())
          .filter(l => l);
      } catch {
        answerLines = [];
      }
    }

    window.addEventListener('DOMContentLoaded', loadRandomProblem);

    document.getElementById('submit-btn').addEventListener('click', async function() {
      const btn = this;
      const fb  = document.getElementById('feedback');
      const ans = document.getElementById('answer').value.toUpperCase().trim();

      if (btn.textContent === 'Submit') {
        if (!/^[A-E]$/.test(ans)) {
          fb.textContent = 'Please enter A, B, C, D, or E.';
          fb.style.color = 'darkorange';
          return;
        }
        const raw = answerLines[currentNum - 1] || '';
        const correct = raw.split('').filter(c => /[A-E]/.test(c));

        if (correct.includes(ans)) {
          fb.textContent = '✅ Correct!';
          fb.style.color = 'green';
        } else {
          const plural = correct.length > 1;
          fb.textContent = `❌ Incorrect — the right answer${plural?'s are':' is'} ${correct.join(' & ')}.`;
          fb.style.color = 'red';
        }
        btn.textContent = 'Next Question';
      } else {
        await loadRandomProblem();
      }
    });
  </script>
</body>
</html>
