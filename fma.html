<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>F=ma Practice</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2em auto; padding: 0 1em; }
    #welcome-page, #practice-container, #test-container, #speed-container, #summary-container { text-align: center; }
    .hidden { display: none; }
    button { padding: 0.5em 1em; margin: 0.5em; font-size: 1em; }
    #mode-buttons button { width: 200px; }
    #timer { font-size: 1.2em; font-weight: bold; margin: 1em 0; color: #333; }
    #problem-counter, #accuracy-summary { margin: 1em 0; font-weight: bold; }
    .problem-wrapper { margin-bottom: 1.5em; }
    .problem-image { display: block; width: 100%; height: auto; margin-bottom: 0.5em; }
    .result-text { font-weight: bold; margin-top: 0.5em; }
  </style>
</head>
<body>
  <!-- Welcome Page -->
  <div id="welcome-page">
    <h1>Welcome Back!</h1>
    <p>Choose a mode to start:</p>
    <div id="mode-buttons">
      <button id="zen-btn">Zen - Unlimited Problems</button>
      <button id="test-btn">Test - Fixed Problems</button>
      <button id="speed-btn">Speed - Time Attack</button>
    </div>
  </div>

  <!-- Zen Practice Container -->
  <div id="practice-container" class="hidden">
    <div id="problem-counter">Problems: 0</div>
    <div id="accuracy-summary">CORRECT: 0 | OVERTIME: 0 | INCORRECT: 0</div>
    <button id="end-practice-btn">End Practice</button>
    <div id="timer">03:00</div>
    <div id="exam-label"></div>
    <div id="image-wrapper"></div>
    <div id="answer-box">
      <input type="text" id="answer" maxlength="1" placeholder="A-E" />
      <button id="submit-btn">Submit</button>
    </div>
    <div id="feedback"></div>
  </div>

  <!-- Test Container -->
  <div id="test-container" class="hidden">
    <h2>Test Mode</h2>
    <button id="start-test-btn">Start Test</button>
    <div id="test-form" class="hidden">
      <form id="test-questions-form">
        <div id="test-questions"></div>
        <button type="button" id="submit-test-btn">Submit Test</button>
      </form>
    </div>
  </div>

  <!-- Speed Container -->
  <div id="speed-container" class="hidden">
    <h2>Speed Mode</h2>
    <button id="start-speed-btn">Start Time Attack</button>
    <div id="speed-timer" class="hidden"></div>
    <div id="speed-problem-area" class="hidden">
      <div id="speed-counter">Solved: 0</div>
      <div id="speed-timer-display"></div>
      <div id="exam-label-speed"></div>
      <div id="image-wrapper-speed"></div>
      <div id="answer-box-speed">
        <input type="text" id="answer-speed" maxlength="1" placeholder="A-E" />
        <button id="submit-speed-btn">Submit</button>
      </div>
      <div id="feedback-speed"></div>
    </div>
  </div>

  <!-- Summary Container -->
  <div id="summary-container" class="hidden">
    <h2>Session Summary</h2>
    <div id="final-summary"></div>
    <button id="restart-btn">Restart</button>
  </div>

  <script>
    // Shared config
    const config = {
      exams: ['2007','2008','2009','2010','2011','2012','2013','2014','2015','2016','2017','2018A','2018B','2019A','2019B','2020A','2020B','2021','2022A','2022B','2023','2024'],
      maxProblems: { '2007':38,'2008':25,'2009':25,'2010':25,'2011':25,'2012':25,'2013':25,'2014':25,'2015':25,'2016':25,'2017':25,'2018A':25,'2018B':25,'2019A':25,'2019B':25,'2020A':25,'2020B':25,'2021':25,'2022A':25,'2022B':25,'2023':25,'2024':25 }
    };
    
    // Elements
    const welcome = document.getElementById('welcome-page');
    const practice = document.getElementById('practice-container');
    const testMode = document.getElementById('test-container');
    const speedMode = document.getElementById('speed-container');
    const summary = document.getElementById('summary-container');

    // Mode buttons
    document.getElementById('zen-btn').onclick = () => startZen();
    document.getElementById('test-btn').onclick = () => startTestMode();
    document.getElementById('speed-btn').onclick = () => startSpeedMode();
    document.getElementById('restart-btn').onclick = () => location.reload();

    // Zen variables
    let zenCount = 0, zenCorrect = 0, zenOvertime = 0, zenIncorrect = 0;
    let currentExam, currentNum, keyAnswers = [], zenTimer, zenTimeLeft;

    // Speed variables
    let speedTime, speedTimerInterval, speedCount = 0;    

    // Utility fetch image parts
    async function fetchImageParts(exam, num) {
      const base = `/static/images/fma/${exam}/${num}`;
      const ext = '.webp'; let parts = [];
      for (let sfx of ['a','b','']) {
        try { if ((await fetch(`${base}${sfx}${ext}`, {method:'HEAD'})).ok) parts.push(`${base}${sfx}${ext}`); }
        catch{};
      }
      return parts;
    }

    // Timer display
    function displayTimer(el, time) {
      if (time <= 0) { el.textContent = 'OVERTIME'; el.style.color = 'red'; }
      else { const m = String(Math.floor(time/60)).padStart(2,'0'); const s = String(time%60).padStart(2,'0'); el.textContent = `${m}:${s}`; el.style.color='#333'; }
    }

    // START ZEN MODE
    async function startZen() {
      welcome.classList.add('hidden'); practice.classList.remove('hidden');
      document.getElementById('end-practice-btn').onclick = showZenSummary;
      await loadZenProblem();
    }

    async function loadZenProblem() {
      zenCount++; updateZenDisplay();
      // fetch new random problem
      [currentExam, currentNum] = getRandomProblem();
      document.getElementById('exam-label').textContent = `Exam ${currentExam} #${currentNum}`;
      // load images
      const wrapper = document.getElementById('image-wrapper'); wrapper.innerHTML = '<div class="loader"></div>';
      const imgs = await fetchImageParts(currentExam, currentNum);
      wrapper.innerHTML = '';
      imgs.forEach(src => { let img = document.createElement('img'); img.src=src; img.className='problem-image'; wrapper.appendChild(img); });
      // load answer key
      try { const keyTxt = await (await fetch(`/static/images/fma/${currentExam}/key.txt`)).text(); keyAnswers = keyTxt.split(/\r?\n/).map(l=>l.trim().toUpperCase()); }catch{ keyAnswers = []; }
      // reset answer and feedback
      document.getElementById('answer').value=''; document.getElementById('feedback').textContent=''; document.getElementById('submit-btn').textContent='Submit';
      // start timer
      zenTimeLeft = 180; clearInterval(zenTimer); zenTimer = setInterval(()=>{
        zenTimeLeft--; displayTimer(document.getElementById('timer'), zenTimeLeft);
        if (zenTimeLeft<=0) clearInterval(zenTimer);
      },1000);

      document.getElementById('submit-btn').onclick = () => handleZenSubmission();
    }

    function handleZenSubmission() {
      const ans = document.getElementById('answer').value.toUpperCase().trim(); const fb = document.getElementById('feedback');
      const raw = keyAnswers[currentNum-1]||''; const corrects = raw.split('').filter(c=>/[A-E]/.test(c));
      let status;
      if (!/^[A-E]$/.test(ans)) { fb.textContent='Enter A-E'; fb.style.color='darkorange'; return; }
      if (corrects.includes(ans)) {
        if (zenTimeLeft>0) { zenCorrect++; status='CORRECT'; fb.textContent='✅ CORRECT'; fb.style.color='green'; }
        else { zenOvertime++; status='OVERTIME'; fb.textContent='⏰ OVERTIME'; fb.style.color='orange'; }
      } else { zenIncorrect++; status='INCORRECT'; fb.textContent=`❌ INCORRECT (Ans: ${corrects.join(' & ')})`; fb.style.color='red'; }
      updateZenDisplay();
      document.getElementById('submit-btn').textContent='Next'; document.getElementById('submit-btn').onclick = () => loadZenProblem();
    }

    function updateZenDisplay() {
      document.getElementById('problem-counter').textContent = `Problems: ${zenCount}`;
      document.getElementById('accuracy-summary').textContent = `CORRECT: ${zenCorrect} | OVERTIME: ${zenOvertime} | INCORRECT: ${zenIncorrect}`;
    }

    function showZenSummary() {
      practice.classList.add('hidden'); summary.classList.remove('hidden');
      document.getElementById('final-summary').innerHTML = `Total: ${zenCount}<br>Correct (fast): ${zenCorrect}<br>Correct (overtime): ${zenOvertime}<br>Incorrect: ${zenIncorrect}`;
    }

    // GET RANDOM PROBLEM HELPER
    function getRandomProblem() {
      const exam = config.exams[Math.floor(Math.random()*config.exams.length)];
      const num = Math.floor(Math.random()*config.maxProblems[exam]) + 1;
      return [exam, num];
    }

    // TEST MODE
    function startTestMode() {
      welcome.classList.add('hidden'); testMode.classList.remove('hidden');
      document.getElementById('start-test-btn').onclick = () => setupTest();
    }

    async function setupTest() {
      document.getElementById('start-test-btn').classList.add('hidden'); document.getElementById('test-form').classList.remove('hidden');
      const totalTime = prompt('Enter total time (minutes):'); const totalProblems = prompt('Enter number of problems:');
      const count = parseInt(totalProblems,10);
      const questionsDiv = document.getElementById('test-questions'); questionsDiv.innerHTML='';
      const testProblems = [];
      for (let i=0;i<count;i++) {
        const [exam,num] = getRandomProblem(); testProblems.push({exam,num});
        const wrapper = document.createElement('div'); wrapper.className='problem-wrapper';
        wrapper.innerHTML = `<h4>${i+1}. Exam ${exam} #${num}</h4><div id="test-img-${i}"><div class=\"loader\"></div></div><input type=\"text\" id=\"ans-${i}\" maxlength=\"1\" placeholder=\"A-E\"/>`;
        questionsDiv.appendChild(wrapper);
        // fetch and display image
        (async()=>{
          const parts = await fetchImageParts(exam,num);
          const cont = document.getElementById(`test-img-${i}`); cont.innerHTML=''; parts.forEach(src=>{let img=new Image();img.src=src;img.className='problem-image';cont.appendChild(img);});
        })();
      }
      document.getElementById('submit-test-btn').onclick = () => gradeTest(testProblems);
    }

    async function gradeTest(probs) {
      let correct=0;
      const results=[];
      // fetch all keys
      const keys={}; for (let p of probs) {
        const txt = await (await fetch(`/static/images/fma/${p.exam}/key.txt`)).text();
        keys[`${p.exam}.${p.num}`] = txt.split(/\r?\n/).map(l=>l.trim().toUpperCase());
      }
      // grade
      probs.forEach((p,i)=>{
        const ans = document.getElementById(`ans-${i}`).value.toUpperCase().trim();
        const raw = keys[`${p.exam}.${p.num}`][p.num-1]||''; const corr = raw.split('').filter(c=>/[A-E]/.test(c));
        const ok = corr.includes(ans);
        results.push(ok ? '✅' : `❌ (Ans: ${corr.join(' & ')})`);
        if(ok) correct++;
      });
      // display results
      const questionsDiv = document.getElementById('test-questions');
      questionsDiv.querySelectorAll('.problem-wrapper').forEach((w,i)=>{
        const res = document.createElement('div'); res.className='result-text'; res.textContent = results[i]; w.appendChild(res);
      });
      questionsDiv.insertAdjacentHTML('beforeend', `<h3>Score: ${correct}/${probs.length}</h3>`);
      document.getElementById('submit-test-btn').disabled = true;
    }

    // SPEED MODE
    function startSpeedMode() {
      welcome.classList.add('hidden'); speedMode.classList.remove('hidden');
      document.getElementById('start-speed-btn').onclick = () => initSpeed();
    }

    function initSpeed() {
      const minutes = parseFloat(prompt('Enter total time (minutes):'));
      if (isNaN(minutes) || minutes<=0) return;
      speedTime = minutes*60; speedCount=0;
      document.getElementById('start-speed-btn').classList.add('hidden');
      document.getElementById('speed-timer').classList.remove('hidden');
      document.getElementById('speed-timer').textContent = `Time Left: ${minutes.toFixed(0)}:00`;
      document.getElementById('speed-problem-area').classList.remove('hidden');
      loadSpeedProblem();
      speedTimerInterval = setInterval(()=>{
        speedTime--;
        const m = String(Math.floor(speedTime/60)).padStart(2,'0');
        const s = String(speedTime%60).padStart(2,'0');
        document.getElementById('speed-timer-display').textContent = `${m}:${s}`;
        if(speedTime<=0) finishSpeed();
      },1000);
      document.getElementById('submit-speed-btn').onclick = () => handleSpeedSubmission();
    }

    async function loadSpeedProblem() {
      speedCount++; document.getElementById('speed-counter').textContent = `Solved: ${speedCount-1}`;
      [currentExam, currentNum] = getRandomProblem();
      document.getElementById('exam-label-speed').textContent = `Exam ${currentExam} #${currentNum}`;
      const wrapper = document.getElementById('image-wrapper-speed'); wrapper.innerHTML = '<div class="loader"></div>';
      const imgs = await fetchImageParts(currentExam, currentNum);
      wrapper.innerHTML=''; imgs.forEach(src=>{let img=new Image();img.src=src;img.className='problem-image';wrapper.appendChild(img);});
      document.getElementById('answer-speed').value=''; document.getElementById('feedback-speed').textContent='';
    }

    function handleSpeedSubmission() {
      const ans = document.getElementById('answer-speed').value.toUpperCase().trim();
      const raw = keyAnswers[currentNum-1]||''; const corrects = raw.split('').filter(c=>/[A-E]/.test(c));
      const fb = document.getElementById('feedback-speed');
      if(corrects.includes(ans)) fb.textContent='✅'; else fb.textContent=`❌ (${corrects.join('/')})`;
      loadSpeedProblem();
    }

    function finishSpeed() {
      clearInterval(speedTimerInterval);
      speedMode.classList.add('hidden'); summary.classList.remove('hidden');
      document.getElementById('final-summary').innerHTML = `Problems Solved: ${speedCount-1}`;
    }
  </script>
</body>
</html>
