<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>F=ma Practice</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2em auto;
      padding: 0 1em;
    }
    #problem-container { text-align: center; }
    h1 { margin-bottom: 0.2em; }
    /* Timer styling */
    #timer {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 1em;
      color: #333;
    }
    #exam-label {
      margin-bottom: 0.5em;
      color: gray;
      font-style: italic;
    }

    /* wrapper now centered at 90% width with a darker box */
    #image-wrapper {
      display: block;
      width: 90%;
      max-width: 800px;
      margin: 0 auto 1em;
      border: 2px solid #000;
      padding: 0.5em;
      box-sizing: border-box;
      min-height: 100px; /* ensure loader has space */
      position: relative;
    }
    .problem-image {
      display: block;
      width: 100%;
      height: auto;
      margin-bottom: 1em;
      border: none;
    }

    #answer-box { margin-top: 1em; }
    #answer-box input {
      width: 60%; padding: 0.5em; font-size: 1em;
      text-transform: uppercase;
    }
    #answer-box button {
      padding: 0.5em 1em; font-size: 1em; margin-left: 0.5em;
    }
    #feedback { margin-top: 1em; font-weight: bold; }

    /* Loader animation by temani afif */
    .loader {
      width: 15px;
      aspect-ratio: 1;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      animation: l9-0 1.5s infinite steps(2);
    }
    .loader::before,
    .loader::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: #000;
    }
    .loader::before {
      box-shadow: 26px 0;
      transform: translateX(-26px);
      animation: l9-1 .75s infinite linear alternate;
    }
    .loader::after {
      transform: translateX(13px) rotate(0deg) translateX(13px);
      animation: l9-2 .75s infinite linear alternate;
    }
    @keyframes l9-0 {
      0%, 49.9% { transform: scale(1) }
      50%, 100% { transform: scale(-1) }
    }
    @keyframes l9-1 {
      100% { box-shadow: 52px 0 }
    }
    @keyframes l9-2 {
      100% { transform: translateX(13px) rotate(-180deg) translateX(13px) }
    }
  </style>
</head>
<body>
  <div id="problem-container">
    <h1>F=ma Practice</h1>
    <div id="timer">03:00</div>
    <div id="exam-label"></div>
    <div id="image-wrapper"></div>
    <div id="answer-box">
      <input type="text" id="answer" maxlength="1" />
      <button id="submit-btn">Submit</button>
    </div>
    <div id="feedback"></div>
  </div>

  <script>
    const config = {
      exams: [
        '2007','2008','2009','2010','2011','2012','2013','2014','2015','2016','2017',
        '2018A','2018B','2019A','2019B','2020A','2020B','2021',
        '2022A','2022B','2023','2024'
      ],
      maxProblems: {
        '2007':25,'2008':25,'2009':25,'2010':25,'2011':25,'2012':25,'2013':25,'2014':25,'2015':25,'2016':25,'2017':25,
        '2018A':25,'2018B':25,'2019A':25,'2019B':25,'2020A':25,'2020B':25,'2021':25,
        '2022A':25,'2022B':25,'2023':25,'2024':25
      }
    };

    let currentExam, currentNum, answerLines = [];
    let timeLeft = 180, timerInterval = null;

    function updateTimerDisplay() {
      const el = document.getElementById('timer');
      if (timeLeft <= 0) {
        el.textContent = 'OVERTIME';
        el.style.color = 'red';
      } else {
        const m = String(Math.floor(timeLeft/60)).padStart(2,'0'),
              s = String(timeLeft%60).padStart(2,'0');
        el.textContent = `${m}:${s}`;
        el.style.color = '#333';
      }
    }
    function startTimer() {
      clearInterval(timerInterval);
      timeLeft = 180;
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) clearInterval(timerInterval);
      }, 1000);
    }

    async function fetchImageParts(exam, num) {
      const base = `/static/images/fma/${exam}/${num}`, ext = '.webp', parts = [];
      for (let sfx of ['a','b']) {
        try {
          const url = `${base}${sfx}${ext}`;
          if ((await fetch(url,{method:'HEAD'})).ok) parts.push(url);
        } catch {}
      }
      if (!parts.length) {
        try {
          const url = `${base}${ext}`;
          if ((await fetch(url,{method:'HEAD'})).ok) parts.push(url);
        } catch {}
      }
      return parts;
    }

    async function loadRandomProblem() {
      let imgs = [];
      const wrapper = document.getElementById('image-wrapper');
      while (!imgs.length) {
        currentExam = config.exams[
          Math.floor(Math.random() * config.exams.length)
        ];
        currentNum = Math.floor(
          Math.random() * config.maxProblems[currentExam]
        ) + 1;
        // show loader
        wrapper.innerHTML = '<div class="loader"></div>';
        imgs = await fetchImageParts(currentExam, currentNum);
      }

      document.getElementById('exam-label').textContent = `Exam ${currentExam}`;
      wrapper.innerHTML = '';
      imgs.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.alt = `F=ma ${currentExam} #${currentNum}`;
        img.className = 'problem-image';
        wrapper.appendChild(img);
      });

      document.getElementById('answer').value = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('submit-btn').textContent = 'Submit';

      try {
        const keyTxt = await (await fetch(
          `/static/images/fma/${currentExam}/key.txt`
        )).text();
        answerLines = keyTxt
          .split(/\r?\n/)
          .map(l => l.trim().toUpperCase())
          .filter(l => l);
      } catch {
        answerLines = [];
      }

      startTimer();
    }

    window.addEventListener('DOMContentLoaded', loadRandomProblem);

    document.getElementById('submit-btn').addEventListener('click', async function() {
      const btn = this, fb = document.getElementById('feedback'),
            ans = document.getElementById('answer').value.toUpperCase().trim();

      if (btn.textContent === 'Submit') {
        if (!/^[A-E]$/.test(ans)) {
          fb.textContent = 'Please enter A, B, C, D, or E.';
          fb.style.color = 'darkorange';
          return;
        }
        const raw = answerLines[currentNum - 1] || '',
              correct = raw.split('').filter(c => /[A-E]/.test(c));

        if (correct.includes(ans)) {
          fb.textContent = '✅ Correct!';
          fb.style.color = 'green';
        } else {
          const plural = correct.length > 1;
          fb.textContent = `❌ Incorrect — the right answer${plural?'s are':' is'} ${correct.join(' & ')}.`;
          fb.style.color = 'red';
        }
        btn.textContent = 'Next Question';
      } else {
        await loadRandomProblem();
      }
    });
  </script>
</body>
</html>
